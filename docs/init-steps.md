# operator-sdk steps
This doc summarizes steps taken to put together this repo. It starts with
a `operator-sdk`, a tool to build kubernetes operators, and describes
changes made to kustomize config files, api structs, controller logic and
custom builds using `podman`.

## initialize project
```
└─ $ ▶ operator-sdk version
operator-sdk version: "v1.15.0", commit: "f6326e832a8a5e5453d0ad25e86714a0de2c0fc8", kubernetes version: "1.21", go version: "go1.16.10", GOOS: "linux", GOARCH: "amd64"
```

Initialize project and make sure the current working folder is truly empty 
and does not have hidden files such as `.gitignore`.
```
operator-sdk init --domain kubetrail.io \
    --owner "kubetrail.io authors" \
    --project-name influxdb-operator \
    --repo github.com/kubetrail/influxdb-operator \
    --skip-go-version-check
```

## create api's
Create API's for various custom resources. `Config` resource does not
have a controller. It's purpose is simply to act as a configmap
```
operator-sdk create api \
    --group influxdb \
    --kind Config \
    --version v1beta1 \
    --namespaced \
    --resource \
    --controller=false 
operator-sdk create api \
    --group influxdb \
    --kind Organization \
    --version v1beta1 \
    --namespaced \
    --resource \
    --controller=true
operator-sdk create api \
    --group influxdb \
    --kind Bucket \
    --version v1beta1 \
    --namespaced \
    --resource \
    --controller=true
operator-sdk create api \
    --group influxdb \
    --kind Token \
    --version v1beta1 \
    --namespaced \
    --resource \
    --controller=true
```

## create webhooks
All API's have defaulting and validating webhooks
```
operator-sdk create webhook \
    --group influxdb \
    --version v1beta1 \
    --kind Config \
    --defaulting \
    --programmatic-validation
operator-sdk create webhook \
    --group influxdb \
    --version v1beta1 \
    --kind Organization \
    --defaulting \
    --programmatic-validation
operator-sdk create webhook \
    --group influxdb \
    --version v1beta1 \
    --kind Bucket \
    --defaulting \
    --programmatic-validation
operator-sdk create webhook \
    --group influxdb \
    --version v1beta1 \
    --kind Token \
    --defaulting \
    --programmatic-validation
```

## update .gitignore
Add following lines for skipping artifact-registry key and
generated manifests that may contain such keys.
```
# extra config setup
/config/extra/artifact-registry-key.yaml
/config/extra/manifests.yaml
/config/samples/manifests.yaml
```

Also same `vendor` folder
```
# Kubernetes Generated files - skip generated files, except for vendored files

#!vendor/**/zz_generated.*

# Vendored files
vendor
```

And make sure to skip any IDE related files:
```
.idea
.vscode
```

## github repo
At this point create a github repo, clone it locally and copy all content from
the previous folder to this one.

## podman build
Add `podman` based build steps to `Makefile` and bring in two `Dockerfile` that
work slightly differently than the one autogenerated using `operator-sdk`
* [podman build make targets](https://github.com/kubetrail/influxdb-operator/blob/main/Makefile#L203-L313)
* [Dockerfile](https://github.com/kubetrail/influxdb-operator/blob/main/Dockerfile-podman)
* [Dockerfile template](https://github.com/kubetrail/influxdb-operator/blob/main/Dockerfile-podman.tmpl)

`podman` is a tool similar to `docker`, however, for Go based code it is easier to cross-build
container images for different OS architectures and link them in a container manifest via
`podman`. These are custom build scripts and may not work for everyone, hence original
autogenerated `docker` based build scripts have not been altered.

`podman-build-push` is a make target that builds container images for `amd64` and
`arm64` and links them together in a container manifest.

```
▶ container images
us-central1-docker.pkg.dev/my-project/my-repo/influxdb-operator  0.0.1-dev-1        843b56261a5b  16 seconds ago      888 B
us-central1-docker.pkg.dev/my-project/my-repo/influxdb-operator  0.0.1-dev-1.arm64  fb51fe9ba4a0  36 seconds ago      51.8 MB
us-central1-docker.pkg.dev/my-project/my-repo/influxdb-operator  0.0.1-dev-1.amd64  c006d80dbd4f  About a minute ago  52.9 MB
```

These build scripts are also specifically designed for Google artifact registry with
a specific folder structure allowing for `tmp`, `amd64` and `arm64` container images
along with the container manifest. In short, it is required that two repos be present
on the Google artifact registry:
* tmp
* artifacts

## extra config
Add extra config to overlay artifact registry key as the image pull secrets in the
operator deployment. This is only required if the container images are behind a 
private registry.
* [extra config folder](https://github.com/kubetrail/influxdb-operator/tree/main/config/extra)

Make sure to change name and the namespace to reflect correct project identifiers:
* [update name and namespace](https://github.com/kubetrail/influxdb-operator/blob/main/config/extra/manager_image_pull_secrets_patch.yaml#L4-L5)

## enable kustomization for default config
This setup assumes that the webhooks are enabled along with cert manager and
prometheus. Therefore, all these three kustomization configs need to be enabled
at two separate places:
* [Enable all in bases](https://github.com/kubetrail/influxdb-operator/blob/main/config/default/kustomization.yaml#L21-L25)
* [Enable all except this one in patchesStrategicMerge](https://github.com/kubetrail/influxdb-operator/blob/main/config/default/kustomization.yaml#L35)
* [Enable everything in vars](https://github.com/kubetrail/influxdb-operator/blob/main/config/default/kustomization.yaml#L47-L74)

Furthermore, enable in `crd` config:
* [Enable all in patchesStrategicMerge](https://github.com/kubetrail/influxdb-operator/blob/main/config/crd/kustomization.yaml#L14-L25)

## update to json logger
Add setup to log in JSON:
* [func](https://github.com/kubetrail/influxdb-operator/blob/main/main.go#L138-L162)
* [call](https://github.com/kubetrail/influxdb-operator/blob/main/main.go#L66-L67)

You may need to update goimports and also run `go mod tidy` at this point

## update api structs
At this point add details to the api structs and controller logic and finally run:
```
go mod tidy
make generate
make manifests
make podman-build-push
make deploy-manifests
```

Details on how controller logic was implemented will be addressed in a separate doc.
